<?xml version="1.0" encoding="UTF-8"?>
<jube>
  <benchmark name="mandel_bench" outpath="bench_run">
    <comment>Run Mandelbrot SIONlib benchmark</comment>
    
    <fileset name="sources">
      <copy>src/*</copy>
    </fileset>

    <substituteset name="compilesub" init_with="platform.xml">
      <iofile in="Makefile.in" out="Makefile" />
    </substituteset>
    
    <step name="compile">
      <use from="platform.xml">compileset</use>
      <use from="platform.xml">libs</use>
      <use>compilesub</use>
      <use>sources</use>
      <do>$load_sionlib; $make SIONCONFIG=$sionconfig</do>
    </step>

    <parameterset name="args" init_with="mandel_bench_platform.xml">
      <parameter name="width" type="int">16384</parameter>
      <parameter name="height" type="int">$width</parameter>
      <parameter name="iterations" type="int">2048</parameter>
      <parameter name="type" type="int">0,1,2</parameter>
    </parameterset>

    <parameterset name="executeset" init_with="mandel_bench_platform.xml">
      <parameter name="executable">compile/mandelmpi</parameter>
      <parameter name="args_exec">-v -t $type -w $width -h $height -i $iterations -b $blocksize</parameter>
      <parameter name="mail"></parameter>
    </parameterset> 

    <step name="execute" depend="compile">
      <use>executeset</use>
      <use>args</use>
      <use from="platform.xml">executesub</use>
      <use from="platform.xml">jobfiles</use>
      <do done_file="$marker_file">$submit $submit_job_script</do> 
    </step>

    <fileset name="sion_output">
      <link rel_path_ref="internal">execute/simple.sion</link>
    </fileset>

    <step name="convert" depend="execute,compile">
      <use>sion_output</use>
      <do>compile/mandelseq</do>
      <do>convert mandelcol.ppm mandelcol.png</do>
      <do>convert mandelcol_procs.ppm mandelcol_procs.png</do>
    </step>

    <patternset name="pattern">
      <pattern name="runtime_ms" unit="ms" reduce="max" type="float">runtime=\s*$jube_pat_fp</pattern> 
      <pattern name="runtime" unit="s" type="float" mode="python">${runtime_ms_max}/1000</pattern>
      <pattern name="calctime_ms" unit="ms" reduce="max" type="float">calc=\s*$jube_pat_fp</pattern>
      <pattern name="calctime" unit="s" type="float" mode="python">${calctime_ms_max}/1000</pattern>
      <pattern name="iotime_ms" unit="ms" reduce="max" type="float">io=\s*$jube_pat_fp</pattern>
      <pattern name="iotime" unit="s" type="float" mode="python">${iotime_ms_max}/1000</pattern>
    </patternset>

    <analyzer name="analyse">
      <use>pattern</use>
      <analyse step="execute">
        <file>stdout</file>
      </analyse>
    </analyzer>

    <result>
      <use>analyse</use>
      <table name="result" style="pretty" sort="tasks,blocksize,type">
        <column>type</column>
        <column>blocksize</column>
        <column>tasks</column>
        <column format=".3f">calctime</column>
	    <column format=".3f">iotime</column>
        <column format=".3f">runtime</column>
      </table>
    </result>
  </benchmark>
</jube>
