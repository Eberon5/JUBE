<?xml version="1.0" encoding="UTF-8"?>
<jube xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="jube2.xsd">

  <!-- jube2 run jube2-partest.xml - -tag jureca -->  

  <!-- global sets -->
  
  <fileset name="sources">
    <copy>sionlib.tar</copy>
    <prepare>tar -xf sionlib.tar</prepare>
  </fileset>


  <!-- partest --> 

  <benchmark name="partest" outpath="./benchmark_runs">
    <comment>partest 2 nodes; 24 rpn; jureca</comment>

    <parameterset name="partestParameter" init_with="partest_specs.xml">
      
    </parameterset>
    
    <parameterset name="systemParameter" init_with="platform.xml">
      <parameter name="nodes" type="int" >2</parameter>  <!--32-->
      <parameter name="taskspernode" type="int" >24</parameter>  <!--16-->
      <parameter name="iodir">${jube_benchmark_home}/io${jube_benchmark_id}-${jube_wp_id}-${jube_wp_iteration}</parameter>
      <parameter tag="deep" name="executable">./compile/partest</parameter>
      <parameter tag="jureca" name="executable">$$EBROOTSIONLIB/bin/partest</parameter>
      <parameter tag="juqueen" name="executable">$SIONLIB_ROOT/bin/partest</parameter>
      <parameter name="args_exec">-f ${iodir}/io${jube_benchmark_id}-${jube_wp_id}-${jube_wp_iteration}.dat -n $numberoffiles -r $chunksize -q $fsblksize  -T ${testtype} -b $bufsize -g $totalsize -s $localsize -F $factor -R $read -W $write -v $verbose -C $nochecksum -L $posix -M $collwrite -m $collread -Z $taskoffset -O $byteoffset -j $serialized -X $unlinkfiles</parameter>
      <parameter name="mail"></parameter>
      <parameter name="timelimit">00:20:00</parameter>
    </parameterset>
    
    <substituteset name="executesub" init_with="platform.xml">
      <sub source="#PREPROCESS#" dest="mkdir -p ${iodir}" />
      <sub source="#POSTPROCESS#" dest="ls -l ${iodir}" />
    </substituteset>
     
    
    <step name="compile" tag="deep">
      <use>sources</use>
      <use>partestParameter</use>
      <do work_dir="sionlib">./configure</do>
      <do work_dir="sionlib">make</do>
      <do work_dir="sionlib">make install</do>
      <do >cp ./sionlib/build-linux-intel-mpich2/build/parutils/partest ${jube_wp_abspath}/${executable}</do>
    </step>

    <step name="compile" export="true" tag="jureca">
      <do>module purge</do>
      <do>module load intel-para</do>
      <do>module load SIONlib</do>
    </step>

    <step name="compile" export="true" tag="juqueen">
      <do>module load sionlib</do>
    </step>

    <step name="execute" depend="compile" shared="shared">
      <use from="platform.xml">executeset</use>
      <use>partestParameter</use>
      <use>systemParameter</use>
      <use from="platform.xml">chainfiles</use>
      <use>executesub</use>
      <use from="platform.xml">jobfiles</use>
      <use from="platform.xml">chainsub</use>
      <do tag="juqueen">chmod u+x $chainjob_script</do>
      <do>$chainjob_script $shared_job_info $submit_script</do>
      <do shared="true" active="$chainjob_needs_submit">$submit_chainjob</do>
      <do done_file="$done_file"></do>
    </step>

    <analyzer name="analyse">
      <use from="partest_specs.xml">pattern</use>
      <analyse step="execute">
        <file tag="deep">stderr</file>
        <file tag="jureca, juqueen">$errlogfile</file>
      </analyse>
    </analyzer>

    <result>
      <use>analyse</use>
      <table name="result" style="pretty" sort="nodes,taskspernode" transpose="true">
	<!-- GETESTET!-->
	<column>pat_number_of_tasks</column>
	<column>pat_startdate</column>
	<column>pat_enddate</column>
	<column>pat_datafile</column>
	<column>pat_nfiles</column>
	<column>pat_randomf</column>
	<column>pat_lbufsize</column>
	<column>pat_lbufsizeb</column>
	<column>pat_gtotsize</column>
	<column>pat_ltotsize</column>
	<column>pat_lchunksize</column>
	<column>pat_lchunksizeb</column>
	<column>pat_fsblksize</column>
	<column>pat_fsblksizeb</column>
	<column>pat_testtype</column>
	<column>pat_serialize_blocknum</column>
	<column>pat_readtaskoffset</column>
	<column>pat_start_offset_bytes</column>
	<column>pat_verbose</column>
	<column>pat_debug</column>
	<column>pat_Debug</column>
	<column>pat_collective_write</column>
	<column>pat_collective_read</column>
	<column>pat_MPI_Large_Block_IO</column>
	<column>pat_MPI_IO_bufsize</column>
	<column>pat_MPI_sparse_access</column>
	<column>pat_suppress_checksum</column>
	<column>pat_do_write</column>
	<column>pat_do_read</column>
	<column>pat_use_posix</column>
	<column>pat_BGIOnodes</column>
	<column>pat_taskpionode</column>
	<column>pat_BG_task_sort</column>
	<column>pat_commwork_size64</column>
	<column>pat_SION_MAIN_VERSION</column>
	<column>pat_SION_SUB_VERSION</column>
	<column>pat_SION_VERSION_PATCHLEVEL</column>
	<column>pat_SION_FILEFORMAT_VERSION</column>
	<column>pat_SION_SVN_REVISION</column>
	<column>pat_alltasks</column>
	<column>pat_worktasks</column>
	<column>pat_localtasks</column>
	<column>pat_ntasks</column>
	<column>pat_new_totalsize</column>
	<column>pat_T_STAT_TASK_WRITE_b_min</column>
	<column>pat_T_STAT_TASK_WRITE_t_avg</column>  
	<column>pat_T_STAT_TASK_WRITE_chunks_avg</column>               
	<column>pat_T_STAT_TASK_WRITE_bw_avg</column>                   
	<column>pat_T_STAT_TASK_WRITE_bw_2_avg</column>                 
	<column>pat_T_PHASE_TASK_WRITE_create</column>                  
	<column>pat_T_PHASE_TASK_WRITE_create_cls</column>              
	<column>pat_T_PHASE_TASK_WRITE_open</column>                    
	<column>pat_T_PHASE_TASK_WRITE_write</column>                   
	<column>pat_T_PHASE_TASK_WRITE_close</column>                  
	<column>pat_T_PHASE_TASK_WRITE_tlog</column>                    
	<column>pat_T_FILE_BARRIER_TASK_WRITE_open_avg</column>      
	<column>pat_T_FILE_BARRIER_TASK_WRITE_write_avg</column>      
	<column>pat_T_FILE_BARRIER_TASK_WRITE_close_avg</column>     
	<column>pat_T_GLOBAL_BARRIER_TASK_WRITE_create_avg</column>  
	<column>pat_T_GLOBAL_BARRIER_TASK_WRITE_create_cls_avg</column>
	<column>pat_T_GLOBAL_BARRIER_TASK_WRITE_open_avg</column>      
	<column>pat_T_GLOBAL_BARRIER_TASK_WRITE_write_avg</column>  
	<column>pat_T_GLOBAL_BARRIER_TASK_WRITE_close_avg</column>     
	<column>pat_T_STAT_TOTAL_WRITE_b</column>
	<column>pat_T_STAT_TOTAL_WRITE_t</column>
	<column>pat_T_STAT_TOTAL_WRITE_chunks</column>
	<column>pat_T_STAT_TOTAL_WRITE_bw</column>
	<column>pat_T_STAT_TOTAL_WRITE_bw_2</column>
	<column>pat_T_PHASE_TOTAL_WRITE_create</column>
	<column>pat_T_PHASE_TOTAL_WRITE_create_cls</column>
	<column>pat_T_PHASE_TOTAL_WRITE_open</column>
	<column>pat_T_PHASE_TOTAL_WRITE_write</column>
	<column>pat_T_PHASE_TOTAL_WRITE_close</column>
	<column>pat_T_PHASE_TOTAL_WRITE_tlog</column>
	<column>pat_T_FILE_BARRIER_TOTAL_WRITE_open</column>
	<column>pat_T_FILE_BARRIER_TOTAL_WRITE_write</column>
	<column>pat_T_FILE_BARRIER_TOTAL_WRITE_close</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_WRITE_create</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_WRITE_create_cls</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_WRITE_open</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_WRITE_write</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_WRITE_close</column>
	<column>pat_T_STAT_TASK_READ_b_avg</column>                  
	<column>pat_T_STAT_TASK_READ_t_avg</column>                   
	<column>pat_T_STAT_TASK_READ_chunks_avg</column>               
	<column>pat_T_STAT_TASK_READ_bw_avg</column>                   
	<column>pat_T_STAT_TASK_READ_bw2_avg</column>                  
	<column>pat_T_PHASE_TASK_READ_open_avg</column>               
	<column>pat_T_PHASE_TASK_READ_read_avg</column>                
	<column>pat_T_PHASE_TASK_READ_close_avg</column>                
	<column>pat_T_PHASE_TASK_READ_tlog_avg</column>                 
	<column>pat_T_FILE_BARRIER_TASK_READ_open_avg</column>          
	<column>pat_T_FILE_BARRIER_TASK_READ_read_avg</column>          
	<column>pat_T_FILE_BARRIER_TASK_READ_close_avg</column>        
	<column>pat_T_GLOBAL_BARRIER_TASK_READ_open_avg</column>      
	<column>pat_T_GLOBAL_BARRIER_TASK_READ_read_avg</column>        
	<column>pat_T_GLOBAL_BARRIER_TASK_READ_close_avg</column>     
	<column>pat_T_STAT_TOTAL_READ_b</column>
	<column>pat_T_STAT_TOTAL_READ_t</column>
	<column>pat_T_STAT_TOTAL_READ_chunks</column>
	<column>pat_T_STAT_TOTAL_READ_bw</column>
	<column>pat_T_STAT_TOTAL_READ_bw2</column>
	<column>pat_T_PHASE_TOTAL_READ_open</column>
	<column>pat_T_PHASE_TOTAL_READ_read</column>
	<column>pat_T_PHASE_TOTAL_READ_close</column>
	<column>pat_T_PHASE_TOTAL_READ_tlog</column>
	<column>pat_T_FILE_BARRIER_TOTAL_READ_open</column>
	<column>pat_T_FILE_BARRIER_TOTAL_READ_read</column>
	<column>pat_T_FILE_BARRIER_TOTAL_READ_close</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_READ_open</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_READ_read</column>
	<column>pat_T_GLOBAL_BARRIER_TOTAL_READ_close</column>
	
      </table>      
    </result>
  </benchmark>
</jube>
